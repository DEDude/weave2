# Overview
Pipeline: Markdown files in the vault → parsed into Note structs (frontmatter + body + links) → projected to RDF triples via tripl → in-process graph indexes built over those triples → exploration, search, and export of notes/graph/RDF views.

# Decisions Locked In
- Language: Go; platform: OS-agnostic Go binary.
- CLI framework: Cobra.
- Vault layout: `notes/<year>/<month>/<id>.md` (filename is id only).
- Canonical storage: Markdown files; frontmatter + body generated by weave2 (no manual boilerplate).
- Link syntax: `[[ID]]` and `[[ID|label]]` only.
- Search scope: everything (title, body, frontmatter fields, tags, link targets).
- RDF: use `tripl` module for primitives and Turtle/N-Triples/JSON-LD encode/decode/convert; do not reimplement.
- RDF vocab strategy: prefer standards (SKOS, FOAF, DCTERMS, schema.org); weave: for custom predicates (e.g., linksTo).
- Graph engine: small in-process layer over projected triples (neighbors, backlinks, filtered traversals).
- SPARQL: nice-to-have, deferred beyond MVP.

# Open Decisions (TODO)
## ID Generation
Criteria: uniqueness; stability across edits/moves; human readability; sortable properties; collision strategy; timezone handling.
- [ ] Draft ADR options (e.g., time-based, random, slugged) vs criteria.
- [ ] Evaluate vault layout impact and collision handling.
- [ ] Choose ID strategy; document rationale and trade-offs.
- [ ] Record migration/backfill approach (if any).
- [ ] Add automated checks/tests for chosen scheme.

# Phased Work Plan (Tasks)
## Phase 1 — Scaffolding & Boundaries
Goal: Establish repo structure and baseline tooling.
Deliverables: `cmd/` Cobra entrypoint, `internal/` packages skeleton, go.mod, make-like helper targets (fmt/test/vet), lint config if any.
Tasks:
- [x] Init Go module; add Cobra dependency; create `cmd/weave2` main wiring stub.
- [x] Create `internal/` package layout (config, notes, markdown, links, search, rdfproj, graph, export).
- [x] Add basic Makefile/scripts for `gofmt`, `go test ./...`, `go vet ./...`.
Acceptance Criteria: Build runs; `go test ./...` passes (empty/smoke); package boundaries clear.
Risks/Gotchas: Avoid naming collisions with `tripl`; keep CLI commands placeholder-only.

## Phase 2 — Config Handling
Goal: Load user config (vault path, editor) with sensible defaults.
Deliverables: Config struct, loader (env/file flags), validation.
Tasks:
- [x] Define config schema and defaults; support overrides via flags/env.
- [x] Validate vault path exists/creatable; resolve to absolute path.
- [x] Provide editor command hook (just stored, not executed yet).
Status: Config struct + Load/validate with env/flag wiring and tests done.
Acceptance Criteria: Config load/validate unit tests; errors are actionable.
Risks/Gotchas: Cross-platform path handling; avoid invoking editor in config layer.

## Phase 3 — Markdown Codec (Frontmatter + Body)
Goal: Read/write Note structs to Markdown with auto-generated frontmatter and skeleton.
Deliverables: Note struct; codec for frontmatter + body; skeleton generator.
Tasks:
- [ ] Define Note fields (id, title, body, tags, dates, links).
- [ ] Implement read: parse frontmatter + body; preserve link text; handle missing optional fields.
- [ ] Implement write: generate frontmatter and basic body scaffold without user typing boilerplate.
Acceptance Criteria: Round-trip tests (struct → md → struct) stable; frontmatter keys consistent.
Risks/Gotchas: Timezone handling for dates; avoid altering body content/whitespace unnecessarily.

## Phase 4 — Vault Scanning & CRUD
Goal: Operate over `notes/<year>/<month>/<id>.md`.
Deliverables: CRUD functions; vault walker.
Tasks:
- [ ] Implement path resolver for year/month/id.
- [ ] List/scan vault to load notes (lazy or eager as chosen).
- [ ] Create/update/delete note files with safe writes (temp + rename).
Acceptance Criteria: CRUD tests with temp dirs; layout enforced.
Risks/Gotchas: File collisions; concurrent writes; permissions.

## Phase 5 — Link Helpers & Parser
Goal: Assist users inserting links without manual IDs; parse existing links.
Deliverables: Helper to format `[[ID|label]]`/`[[ID]]`; parser to extract targets.
Tasks:
- [ ] Implement formatter that takes id + optional label.
- [ ] Implement parser to extract link targets and labels from body text.
Acceptance Criteria: Unit tests covering edge cases (nested brackets, punctuation).
Risks/Gotchas: Avoid false positives in code blocks; Unicode in labels if encountered.

## Phase 6 — Search (Scan-First)
Goal: Search across title, body, frontmatter, tags, link targets.
Deliverables: Search module with simple scan implementation.
Tasks:
- [ ] Define query struct and result shape.
- [ ] Implement scan-based search over loaded notes; rank/sort basic.
- [ ] Tests for matching across fields and links.
Acceptance Criteria: Search returns expected matches in tests; handles empty results gracefully.
Risks/Gotchas: Performance on large vaults (acceptable for v0.1); case folding decisions.

## Phase 7 — RDF Projection
Goal: Project Notes to RDF triples using tripl and vocab strategy.
Deliverables: Converter Note → []tripl.Triple; vocab mapping.
Tasks:
- [ ] Map fields: dcterms:title, dcterms:identifier, dcterms:created/modified, schema:text, skos:Concept for tags, weave:linksTo for links, foaf:Person if authors exist.
- [ ] Use tripl constructors; no reimplementation.
- [ ] Tests for triple contents and serialization via tripl encoders (Turtle/N-Triples/JSON-LD).
Acceptance Criteria: Triples match expected IRIs/literals in tests; serialize without errors.
Risks/Gotchas: IRI base/curie handling; literal datatype for dates.

## Phase 8 — Graph Engine
Goal: Build adjacency/backlink indexes over triples; expose query methods.
Deliverables: In-process graph module (neighbors, backlinks, ego network/filter).
Tasks:
- [ ] Build indexes from projected triples (link predicates).
- [ ] Query helpers: neighbors(id), backlinks(id), filtered traversal hooks.
- [ ] Tests for small graphs, including cycles and orphan nodes.
Acceptance Criteria: Queries return correct sets; performance acceptable for in-memory scale.
Risks/Gotchas: Keep separation from tripl; ensure deterministic iteration order for tests.

## Phase 9 — Export Utilities
Goal: Export RDF dataset in multiple formats via tripl.
Deliverables: Export functions for Turtle, N-Triples, JSON-LD.
Tasks:
- [ ] Wire tripl encoders for supported formats.
- [ ] Provide file/stream output helpers; handle overwrite guards.
- [ ] Tests: format round-trips and non-empty outputs.
Acceptance Criteria: Exports succeed with sample notes; files readable by standard tools.
Risks/Gotchas: Charset/line-ending consistency; large output memory use.

## Phase 10 — CLI Wiring (Cobra)
Goal: Expose features via Cobra commands (placeholders ok).
Deliverables: Command tree skeleton, flag binding to config/modules.
Tasks:
- [ ] Define root and subcommands (names TBD); bind config.
- [ ] Connect commands to modules (CRUD, search, export) via interfaces.
- [ ] Add help/usage text stubs.
Acceptance Criteria: `go test ./...` passes; `go run ... --help` works; commands call into modules in tests/mocks.
Risks/Gotchas: Avoid hardcoding ID scheme; keep UX stable despite TBD names.

## Phase 11 — Testing & CI
Goal: Baseline quality gates.
Deliverables: Unit tests per module; CI config for fmt/test/vet.
Tasks:
- [ ] Add tests: markdown codec, link parser, search, rdf projection, graph indexing.
- [ ] Configure CI workflow (fmt, vet, test).
- [ ] Ensure deterministic tests (no current time unless injected).
Acceptance Criteria: CI green; coverage hits core logic; no race warnings.
Risks/Gotchas: Time-dependent tests; platform-specific paths.

# Collaboration Notes
- Work TDD-first from here: write/extend tests before implementing code.
- I provide command snippets and code examples; I only write/change files when explicitly asked to apply them.
- Git commit messages: emphasize the why over the what; the diff already shows what changed.
- Between phases, pause for a brief review of inefficiencies and refactoring opportunities before moving on.

# Milestones
- M1: Repo scaffolding ready; Cobra stub builds; CI pipeline runs fmt/vet/test.
- M2: Notes round-trip: create Note struct → write Markdown → read back → matches; link parser/helper working.
- M3: Vault CRUD + search across fields operational in scan mode.
- M4: RDF projection + export produce valid Turtle/N-Triples/JSON-LD for sample vault.
- M5: Graph engine builds from triples; neighbors/backlinks queries return expected results via CLI wiring stubs.

# Definition of Done for v0.1
- Buildable Go binary with Cobra skeleton; config loads with vault path defaults.
- Notes can be created/read/updated/deleted in `notes/<year>/<month>/<id>.md` with autogenerated frontmatter/body skeleton.
- Links can be inserted via helper and parsed from bodies.
- Search works across all fields (scan-based).
- Notes project to RDF via tripl using specified vocab; exports emit Turtle/N-Triples/JSON-LD.
- In-process graph supports neighbors/backlinks over projected triples.
- gofmt/go vet/go test all pass; CI green.

# Future Work (Post v0.1)
- Caching/index persistence under `.weave/`.
- File watching for incremental graph rebuild.
- SPARQL endpoint or embedded engine.
- Graph visualization server/UI.
- Import RDF -> notes (optional).
